name: Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      branch:
        description: 'Git branch to use'
        required: true
        default: 'master'
        type: string

env:
  TF_VERSION: 1.5.4

jobs:
  terraform-destroy:
    name: Destroy ${{ inputs.environment }} environment
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read

    defaults:
      run:
        working-directory: vanilla-ga/terraform/envs/${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.branch }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: TerraformDestroy-${{ inputs.environment }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init (backend from env vars)
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ vars.BACKEND_BUCKET }}" \
            -backend-config="key=${{ vars.BACKEND_KEY_PREFIX }}/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.BACKEND_DDB_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Select/create workspace
        run: |
          WORKSPACE="${{ inputs.environment }}"
          echo "Ensuring workspace '$WORKSPACE' exists and is selected..."
          if terraform workspace list | sed 's/^[* ]*//g' | grep -qx "$WORKSPACE"; then
            terraform workspace select "$WORKSPACE"
          else
            terraform workspace new "$WORKSPACE"
          fi

      - name: Terraform destroy
        run: terraform destroy -input=false -auto-approve
