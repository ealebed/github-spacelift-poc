name: Deploy Terraform to AWS

on:
  push:
    branches:
      - master
    paths:
      - .github/workflows/tf-apply.yml
      - .github/workflows/tf-plan.yml
      - 'terraform/**/*.tf'

env:
  TF_VERSION: 1.5.4
#   DEV_PLAN_FILE: dev_tfplan
#   PROD_PLAN_FILE: prod_tfplan

jobs:
  # 1) DEV: validate + plan + apply automatically
  terraform-dev:
    name: Terraform DEV — plan & apply
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    environment: dev
    defaults:
      run:
        working-directory: terraform/envs/dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Configure AWS credentials (DEV)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActionsSession-dev
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init (DEV)
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ vars.BACKEND_BUCKET }}" \
            -backend-config="key=${{ vars.BACKEND_KEY_PREFIX }}/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.BACKEND_DDB_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform fmt (DEV)
        run: terraform fmt -check

      - name: Terraform validate (DEV)
        run: terraform validate -no-color

      - name: Terraform workspace (DEV)
        run: terraform workspace new dev || terraform workspace select dev

    #   - name: Terraform plan (DEV)
    #     run: terraform plan -input=false -no-color -out ${{ env.DEV_PLAN_FILE }}

      - name: Terraform apply (DEV)
        run: terraform apply -input=false -auto-approve # ${{ env.DEV_PLAN_FILE }}

  # 2) PROD: plan only, upload plan as artifact
  terraform-prod-plan:
    name: Terraform PROD — plan
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    needs: [terraform-dev]
    environment: prod
    defaults:
      run:
        working-directory: terraform/envs/prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Configure AWS credentials (PROD)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActionsSession-prod
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init (PROD)
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ vars.BACKEND_BUCKET }}" \
            -backend-config="key=${{ vars.BACKEND_KEY_PREFIX }}/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.BACKEND_DDB_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform fmt (PROD)
        run: terraform fmt -check

      - name: Terraform validate (PROD)
        run: terraform validate -no-color

      - name: Terraform workspace (PROD)
        run: terraform workspace new prod || terraform workspace select prod

      - name: Terraform plan (PROD)
        run: terraform plan -input=false -no-color -out ${{ env.PROD_PLAN_FILE }}

      - name: Upload PROD plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: prod-execution-plan
          path: terraform/envs/prod/${{ env.PROD_PLAN_FILE }}

  # 3) Manual approval before PROD apply
  approval-prod:
    name: Manual approval for PROD apply
    runs-on: ubuntu-latest
    needs: [terraform-dev]
    permissions:
      issues: write
    steps:
      - name: Manual approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.token }}
          approvers: ealebed
          minimum-approvals: 1
          issue-title: "Approve Terraform PROD apply"
          issue-body: "Approve applying Terraform changes to PROD for run #${{ github.run_number }}"

  # 4) PROD: apply the approved plan
  terraform-prod-apply:
    name: Terraform PROD — apply
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    needs: [approval-prod]
    environment: prod
    defaults:
      run:
        working-directory: terraform/envs/prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Configure AWS credentials (PROD)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActionsSession-prod
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init (PROD)
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ vars.BACKEND_BUCKET }}" \
            -backend-config="key=${{ vars.BACKEND_KEY_PREFIX }}/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.BACKEND_DDB_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform fmt (PROD)
        run: terraform fmt -check

      - name: Terraform validate (PROD)
        run: terraform validate -no-color

      - name: Terraform workspace (PROD)
        run: terraform workspace new prod || terraform workspace select prod

    #   - name: Download PROD plan artifact
    #     uses: actions/download-artifact@v4
    #     with:
    #       name: prod-execution-plan
    #       path: terraform/envs/prod

      - name: Terraform apply (PROD)
        run: terraform apply -input=false -auto-approve # ${{ env.PROD_PLAN_FILE }}
