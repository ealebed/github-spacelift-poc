name: Deploy Terraform to AWS

on:
  push:
    branches:
      - master
    paths:
      - .github/workflows/tf-apply.yml
      - .github/workflows/tf-plan.yml
      - 'terraform/**/*.tf'

env:
  TF_VERSION: 1.5.4

jobs:
  # 1) DEV: validate + apply automatically
  terraform-dev:
    name: Terraform DEV — apply
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    environment: dev
    defaults:
      run:
        working-directory: terraform/envs/dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Configure AWS credentials (DEV)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActionsSession-dev
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init (DEV)
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ vars.BACKEND_BUCKET }}" \
            -backend-config="key=${{ vars.BACKEND_KEY_PREFIX }}/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.BACKEND_DDB_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform fmt (DEV)
        run: terraform fmt -check

      - name: Terraform validate (DEV)
        run: terraform validate -no-color

      - name: Terraform workspace (DEV)
        run: |
          WORKSPACE="dev"
          echo "Ensuring workspace '$WORKSPACE' exists and is selected..."
          if terraform workspace list | sed 's/^[* ]*//g' | grep -qx "$WORKSPACE"; then
            terraform workspace select "$WORKSPACE"
          else
            terraform workspace new "$WORKSPACE"
          fi

      - name: Terraform apply (DEV)
        run: terraform apply -input=false -auto-approve

  # 2) Manual approval before PROD apply
  approval-prod:
    name: Manual approval for PROD apply
    runs-on: ubuntu-latest
    needs: [terraform-dev]
    permissions:
      issues: write
    steps:
      - name: Manual approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.token }}
          approvers: ealebed
          minimum-approvals: 1
          issue-title: "Approve Terraform PROD apply"
          issue-body: "Approve applying Terraform changes to PROD for run #${{ github.run_number }}"

  # 3) PROD: apply
  terraform-prod-apply:
    name: Terraform PROD — apply
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    needs: [approval-prod]
    environment: prod
    defaults:
      run:
        working-directory: terraform/envs/prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Configure AWS credentials (PROD)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActionsSession-prod
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init (PROD)
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ vars.BACKEND_BUCKET }}" \
            -backend-config="key=${{ vars.BACKEND_KEY_PREFIX }}/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.BACKEND_DDB_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform fmt (PROD)
        run: terraform fmt -check

      - name: Terraform validate (PROD)
        run: terraform validate -no-color

      - name: Terraform workspace (PROD)
        run: |
          WORKSPACE="prod"
          echo "Ensuring workspace '$WORKSPACE' exists and is selected..."
          if terraform workspace list | sed 's/^[* ]*//g' | grep -qx "$WORKSPACE"; then
            terraform workspace select "$WORKSPACE"
          else
            terraform workspace new "$WORKSPACE"
          fi

      - name: Terraform apply (PROD)
        run: terraform apply -input=false -auto-approve
