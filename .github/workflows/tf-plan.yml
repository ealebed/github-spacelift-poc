name: Pull Requests quality gate

on:
  pull_request:
    branches:
      - master
    paths:
      - .github/workflows/tf-apply.yml
      - .github/workflows/tf-plan.yml
      - 'vanilla-ga/terraform/**/*.tf'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  TF_PLAN_FILE: terraform.tfplan
  TF_VERSION: 1.5.4

jobs:
  paths-filter:
    name: Filter Paths
    runs-on: ubuntu-latest
    outputs:
      dev: ${{ steps.filter.outputs.dev }}
      prod: ${{ steps.filter.outputs.prod }}
    steps:
      - name: Checkout the latest commit
        uses: actions/checkout@v5

      - name: Validate changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            dev:
              - 'vanilla-ga/terraform/modules/**'
              - 'vanilla-ga/terraform/envs/dev/**'
            prod:
              - 'vanilla-ga/terraform/modules/**'
              - 'vanilla-ga/terraform/envs/prod/**'

  terraform-plan:
    timeout-minutes: 10
    name: Terraform plan â€” ${{ matrix.environment }}
    needs:
      - paths-filter
    if: ${{ needs.paths-filter.outputs.dev == 'true' && always() }} || ${{ needs.paths-filter.outputs.prod == 'true' && always() }}
    strategy:
      fail-fast: false
      matrix:
        environment: ["dev", "prod"]
    environment: ${{ matrix.environment }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: vanilla-ga/terraform/envs/${{ matrix.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Login to AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActionsSession-${{ matrix.environment }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init
        id: tf-init
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ vars.BACKEND_BUCKET }}" \
            -backend-config="key=${{ vars.BACKEND_KEY_PREFIX }}/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.BACKEND_DDB_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform fmt
        id: tf-fmt
        run: terraform fmt -check

      - name: Terraform validate
        id: tf-validate
        run: terraform validate -no-color

      - name: Terraform workspace
        id: tf-workspace
        run: |
          WORKSPACE="${{ matrix.environment }}"
          echo "Ensuring workspace '$WORKSPACE' exists and is selected..."
          if terraform workspace list | sed 's/^[* ]*//g' | grep -qx "$WORKSPACE"; then
            terraform workspace select "$WORKSPACE"
          else
            terraform workspace new "$WORKSPACE"
          fi

      - name: Terraform plan
        id: tf-plan
        run: |
          terraform plan -input=false -out ${{ env.TF_PLAN_FILE }}
